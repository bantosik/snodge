
js_outdir=out/js

js_src_main:=$(call srcfiles,js,main)
js_src_test:=$(call srcfiles,js,test)

JS_KOTLINC=kotlinc-js
JS_KOTLINC_FLAGS=-meta-info -source-map -target v5 -module-kind umd -language-version 1.1 -api-version 1.1

JS_LIB_SCRIPTS=$(js_outdir)/lib/kotlin.js $(js_outdir)/lib/kotlin-test.js
.PRECIOUS: $(JS_LIB_SCRIPTS)


js: $(js_outdir)/test-report.txt $(js_outdir)/$(package)-js.jar $(js_outdir)/$(package)-test-js.jar
js-tested: $(js_outdir)/test-report.txt
js-ci: js

$(js_outdir)/%-js.jar: $(js_outdir)/%.js
	cd $(dir $@) && $(JAR) cf $(abspath $@) $*.js $*.meta.js $*/

$(js_outdir)/$(package).js: $(js_src_main)
	@mkdir -p $(dir $@)
	$(JS_KOTLINC) $(JS_KOTLINC_FLAGS) -output $@ $^

$(js_outdir)/$(package)-test.js: $(js_src_test) $(js_outdir)/$(package)-js.jar
	@mkdir -p $(dir $@)
	$(JS_KOTLINC) $(JS_KOTLINC_FLAGS) -output $@ $(filter %.kt,$^) -libraries $(js_outdir)/$(package)-js.jar:$(KOTLINHOME)/lib/kotlin-test-js.jar


$(js_outdir)/test-report.txt: $(js_outdir)/$(package).js $(js_outdir)/$(package)-test.js $(JS_LIB_SCRIPTS) test-js.html
	@mkdir -p $(dir $@)
	./node_modules/.bin/node-qunit-phantomjs test-js.html $(QUNIT_FLAGS) | tee $@

$(js_outdir)/lib/kotlin.js: $(KOTLINHOME)/lib/kotlin-stdlib-js.jar
$(js_outdir)/lib/kotlin-test.js: $(KOTLINHOME)/lib/kotlin-test-js.jar

$(js_outdir)/lib/%.js:
	@mkdir -p $(dir $@)
	cd $(dir $@) && $(JAR) xf $(abspath $<) $(notdir $@)
	touch $@

.PHONY: js js-ci
